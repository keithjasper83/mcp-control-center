{% extends "layout.html" %}

{% block title %}Projects - MCP Control Center{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header with Actions -->
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-900">Projects</h1>
        <div class="flex gap-3">
            <button
                id="sync-github-btn"
                class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 font-semibold flex items-center gap-2"
                onclick="syncFromGitHub()"
            >
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                Sync from GitHub
            </button>
            <button
                class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 font-semibold"
                onclick="showCreateProjectModal()"
            >
                + New Project
            </button>
        </div>
    </div>

    <!-- Status Messages -->
    <div id="status-message" class="hidden"></div>

    <!-- Projects Grid -->
    <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Projects will be loaded here -->
    </div>

    <!-- Create Project Modal (hidden by default) -->
    <div id="create-project-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold mb-4">Create New Project</h2>
            <form id="create-project-form" onsubmit="createProject(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Project Name</label>
                        <input
                            type="text"
                            id="project-name"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            placeholder="my-awesome-project"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea
                            id="project-description"
                            rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            placeholder="Project description..."
                        ></textarea>
                    </div>
                    <div class="flex items-center">
                        <input
                            type="checkbox"
                            id="create-github-repo"
                            class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                        >
                        <label for="create-github-repo" class="ml-2 text-sm text-gray-700">
                            Create GitHub repository
                        </label>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button
                            type="submit"
                            class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 font-semibold"
                        >
                            Create
                        </button>
                        <button
                            type="button"
                            onclick="hideCreateProjectModal()"
                            class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 font-semibold"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load projects on page load
    async function loadProjects() {
        try {
            const response = await fetch('/api/projects');
            const projects = await response.json();
            
            const grid = document.getElementById('projects-grid');
            
            if (projects.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <p class="text-gray-500 text-lg">No projects yet. Create one or sync from GitHub!</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = projects.map(project => `
                <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold text-gray-900">${project.name}</h3>
                        ${project.repo_url ? `
                            <a href="${project.repo_url}" target="_blank" class="text-gray-600 hover:text-gray-900">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                </svg>
                            </a>
                        ` : ''}
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        ${Object.keys(project.language_matrix || {}).length > 0 ? `
                            <div class="flex flex-wrap gap-2">
                                ${Object.keys(project.language_matrix).map(lang => `
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${lang}</span>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${project.tags && project.tags.length > 0 ? `
                            <div class="flex flex-wrap gap-2">
                                ${project.tags.map(tag => `
                                    <span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">${tag}</span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="flex gap-2">
                        <a href="/features?project=${project.id}" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                            View Features â†’
                        </a>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading projects:', error);
            showStatus('Failed to load projects', 'error');
        }
    }

    async function syncFromGitHub() {
        const btn = document.getElementById('sync-github-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="animate-pulse">Syncing...</span>';
        
        try {
            const response = await fetch('/api/github/sync', {
                method: 'POST'
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Sync failed');
            }
            
            const result = await response.json();
            showStatus(`Synced ${result.total} repositories (${result.created} new, ${result.synced} updated)`, 'success');
            await loadProjects();
        } catch (error) {
            console.error('Error syncing:', error);
            showStatus(error.message || 'Failed to sync from GitHub. Make sure GITHUB_TOKEN is configured.', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = `
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                Sync from GitHub
            `;
        }
    }

    async function createProject(event) {
        event.preventDefault();
        
        const name = document.getElementById('project-name').value;
        const description = document.getElementById('project-description').value;
        const createGitHub = document.getElementById('create-github-repo').checked;
        
        try {
            if (createGitHub) {
                // Create both GitHub repo and project
                const response = await fetch(`/api/github/repositories?name=${encodeURIComponent(name)}&description=${encodeURIComponent(description)}`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create repository');
                }
                
                const result = await response.json();
                showStatus(`Created project and GitHub repository: ${result.github_repo.url}`, 'success');
            } else {
                // Create project only
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        language_matrix: {},
                        tags: []
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to create project');
                }
                
                showStatus('Project created successfully', 'success');
            }
            
            hideCreateProjectModal();
            await loadProjects();
        } catch (error) {
            console.error('Error creating project:', error);
            showStatus(error.message || 'Failed to create project', 'error');
        }
    }

    function showCreateProjectModal() {
        document.getElementById('create-project-modal').classList.remove('hidden');
    }

    function hideCreateProjectModal() {
        document.getElementById('create-project-modal').classList.add('hidden');
        document.getElementById('create-project-form').reset();
    }

    function showStatus(message, type) {
        const statusEl = document.getElementById('status-message');
        statusEl.className = `p-4 rounded-lg ${
            type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
        }`;
        statusEl.textContent = message;
        statusEl.classList.remove('hidden');
        
        setTimeout(() => {
            statusEl.classList.add('hidden');
        }, 5000);
    }

    // Load projects on page load
    loadProjects();
</script>
{% endblock %}
