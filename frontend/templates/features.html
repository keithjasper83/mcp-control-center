{% extends "layout.html" %}

{% block title %}Features - MCP Control Center{% endblock %}

{% block content %}
<div class="space-y-6" x-data="{ selectedProject: null, showCreateModal: false }">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-900">Features</h1>
        <button
            @click="showCreateModal = true"
            class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 font-semibold"
        >
            + New Feature
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-md p-4">
        <div class="flex flex-wrap gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Project</label>
                <select
                    x-model="selectedProject"
                    @change="loadFeatures()"
                    class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                >
                    <option value="">All Projects</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select
                    id="status-filter"
                    class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                >
                    <option value="">All Statuses</option>
                    <option value="DRAFT">Draft</option>
                    <option value="PLANNED">Planned</option>
                    <option value="IN_PROGRESS">In Progress</option>
                    <option value="DONE">Done</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Status Message -->
    <div id="status-message" class="hidden"></div>

    <!-- Features List -->
    <div id="features-list" class="space-y-4">
        <!-- Features will be loaded here -->
    </div>

    <!-- Create Feature Modal -->
    <div
        x-show="showCreateModal"
        x-cloak
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4" @click.away="showCreateModal = false">
            <h2 class="text-2xl font-bold mb-4">Create New Feature</h2>
            <form id="create-feature-form" @submit.prevent="createFeature()">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Project</label>
                        <select
                            id="feature-project"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        >
                            <option value="">Select project...</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                        <input
                            type="text"
                            id="feature-title"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            placeholder="Feature title"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea
                            id="feature-description"
                            rows="4"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            placeholder="Feature description in Markdown..."
                        ></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select
                                id="feature-status"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            >
                                <option value="DRAFT">Draft</option>
                                <option value="PLANNED">Planned</option>
                                <option value="IN_PROGRESS">In Progress</option>
                                <option value="DONE">Done</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                            <input
                                type="number"
                                id="feature-priority"
                                value="3"
                                min="1"
                                max="5"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            >
                        </div>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button
                            type="submit"
                            class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 font-semibold"
                        >
                            Create Feature
                        </button>
                        <button
                            type="button"
                            @click="showCreateModal = false"
                            class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 font-semibold"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadProjects() {
        try {
            const response = await fetch('/api/projects');
            const projects = await response.json();
            
            const selects = [
                document.querySelector('select[x-model="selectedProject"]'),
                document.getElementById('feature-project')
            ];
            
            selects.forEach(select => {
                if (!select) return;
                const currentOptions = select.querySelectorAll('option:not(:first-child)');
                currentOptions.forEach(opt => opt.remove());
                
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    select.appendChild(option);
                });
            });
        } catch (error) {
            console.error('Error loading projects:', error);
        }
    }

    async function loadFeatures() {
        try {
            const response = await fetch('/api/features');
            const features = await response.json();
            
            const list = document.getElementById('features-list');
            
            if (features.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12 bg-white rounded-lg shadow-md">
                        <p class="text-gray-500 text-lg">No features yet. Create your first one!</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = features.map(feature => {
                const statusColors = {
                    'DRAFT': 'bg-gray-100 text-gray-800',
                    'PLANNED': 'bg-blue-100 text-blue-800',
                    'IN_PROGRESS': 'bg-yellow-100 text-yellow-800',
                    'DONE': 'bg-green-100 text-green-800'
                };
                
                return `
                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-xl font-bold text-gray-900">${feature.title}</h3>
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColors[feature.status] || 'bg-gray-100 text-gray-800'}">
                                ${feature.status}
                            </span>
                        </div>
                        
                        ${feature.description_md ? `
                            <p class="text-gray-600 mb-4">${feature.description_md}</p>
                        ` : ''}
                        
                        <div class="flex items-center gap-4 text-sm text-gray-500">
                            <span>Priority: ${feature.priority}</span>
                            ${feature.labels && feature.labels.length > 0 ? `
                                <div class="flex gap-2">
                                    ${feature.labels.map(label => `
                                        <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded">${label}</span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading features:', error);
            showStatus('Failed to load features', 'error');
        }
    }

    async function createFeature() {
        const projectId = parseInt(document.getElementById('feature-project').value);
        const title = document.getElementById('feature-title').value;
        const description = document.getElementById('feature-description').value;
        const status = document.getElementById('feature-status').value;
        const priority = parseInt(document.getElementById('feature-priority').value);
        
        if (!projectId || !title) {
            showStatus('Please fill in all required fields', 'error');
            return;
        }
        
        try {
            const response = await fetch('/api/features', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    project_id: projectId,
                    title: title,
                    description_md: description,
                    status: status,
                    priority: priority,
                    labels: [],
                    mcp_ids: []
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to create feature');
            }
            
            showStatus('Feature created successfully', 'success');
            document.getElementById('create-feature-form').reset();
            await loadFeatures();
        } catch (error) {
            console.error('Error creating feature:', error);
            showStatus('Failed to create feature', 'error');
        }
    }

    function showStatus(message, type) {
        const statusEl = document.getElementById('status-message');
        statusEl.className = `p-4 rounded-lg ${
            type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
        }`;
        statusEl.textContent = message;
        statusEl.classList.remove('hidden');
        
        setTimeout(() => {
            statusEl.classList.add('hidden');
        }, 5000);
    }

    // Load data on page load
    loadProjects();
    loadFeatures();
</script>
{% endblock %}
